# 回放功能 UI 示意圖 (Replay Feature UI Mockup)

## 正常遊戲狀態 (Normal Game State)

```
┌─────────────────────────────────────────────────────────────────┐
│  國際象棋 - 雙人對弈                                              │
├─────────────────────────────────────────────────────────────────┤
│  遊戲  設定                                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│     ┌────────────────────────┐                                   │
│     │                        │  時間控制面板                      │
│     │   [8x8 棋盤]          │  ┌──────────────┐                 │
│     │                        │  │ 白方時間: 5分 │                 │
│     │   ♔♕♖♗♘♙              │  │ 黑方時間: 5分 │                 │
│     │                        │  │ 每著加秒: 3秒 │                 │
│     └────────────────────────┘  │              │                 │
│                                  │ [開始] 按鈕  │                 │
│     [◄ 上一步]  [下一步 ►]      └──────────────┘                 │
│     (初始狀態：兩個按鈕都禁用)                                     │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 下了幾步棋後 (After Several Moves)

```
┌─────────────────────────────────────────────────────────────────┐
│  國際象棋 - 雙人對弈                                              │
├─────────────────────────────────────────────────────────────────┤
│  遊戲  設定                                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  03:47    ┌────────────────────────┐  04:23                     │
│  ⏱ 黑方   │                        │  ⏱ 白方                    │
│     │     │   [8x8 棋盤]          │                             │
│     │     │                        │     放棄按鈕已顯示           │
│     │     │   棋子已移動...        │     [放棄]                  │
│     │     │                        │                             │
│     │     └────────────────────────┘                             │
│     │                                                             │
│     └─>[◄ 上一步]  [下一步 ►]◄─ 上一步按鈕現在啟用              │
│         (可以查看歷史)    (禁用)                                  │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 進入回放模式 (In Replay Mode)

點擊「◄ 上一步」後：

```
┌─────────────────────────────────────────────────────────────────┐
│  國際象棋 - 雙人對弈                                              │
├─────────────────────────────────────────────────────────────────┤
│  遊戲  設定                                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  03:47    ┌────────────────────────┐  04:23                     │
│  ⏱ 黑方   │                        │  ⏱ 白方                    │
│     │     │   [8x8 棋盤]          │                             │
│     │     │                        │                             │
│     │     │   顯示第 3 步的狀態    │     [放棄]                  │
│     │     │   (不能移動棋子)       │                             │
│     │     └────────────────────────┘                             │
│     │                                                             │
│     └─>[◄ 上一步]  🔴回放模式 (3/5)🔴  [下一步 ►]◄─ 兩個按鈕都啟用│
│         (可繼續後退)  紅色警示標籤     (可以前進)                 │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 回到目前狀態 - 自動退出回放模式 (Return to Current State - Auto-Exit)

持續點擊「下一步 ►」直到第 5 步（最新狀態）：

```
┌─────────────────────────────────────────────────────────────────┐
│  國際象棋 - 雙人對弈                                              │
├─────────────────────────────────────────────────────────────────┤
│  遊戲  設定                                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  03:47    ┌────────────────────────┐  04:23                     │
│  ⏱ 黑方   │                        │  ⏱ 白方                    │
│     │     │   [8x8 棋盤]          │                             │
│     │     │                        │                             │
│     │     │   最新狀態              │     [放棄]                  │
│     │     │   ✅ 可以移動棋子       │                             │
│     │     └────────────────────────┘                             │
│     │                                                             │
│     └─>[◄ 上一步]              [下一步 ►]                        │
│         (啟用)      ✅ 回放模式指示已自動隱藏  (禁用)             │
│                     ✅ 自動退出回放模式                            │
│                     ✅ 恢復正常對弈                               │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 功能流程圖 (Feature Flow Diagram)

```
開始遊戲
   ↓
下了幾步棋 (例如: 5步)
   ↓
moveHistory = [Move1, Move2, Move3, Move4, Move5]
currentMoveIndex = 4 (0-based, 指向 Move5)
   ↓
點擊「◄ 上一步」
   ↓
進入回放模式 (isInReplayMode = true)
currentMoveIndex = 3 (顯示 Move4 後的狀態)
顯示: "回放模式 (4/5)"
棋子無法移動 ❌
   ↓
繼續點擊「◄ 上一步」
   ↓
currentMoveIndex = 2, 1, 0... (可以一直回退)
   ↓
點擊「下一步 ►」
   ↓
currentMoveIndex = 1, 2, 3, 4...
   ↓
到達 currentMoveIndex = 4 (最新狀態)
   ↓
🔔 自動觸發 exitReplayMode()
   ↓
✅ isInReplayMode = false
✅ 隱藏回放模式指示
✅ 可以移動棋子
✅ 繼續正常對弈
```

## 核心邏輯：自動退出條件 (Core Logic: Auto-Exit Condition)

```cpp
// 在 ChessBoard::goToNextMove() 中
if (m_currentMoveIndex == static_cast<int>(m_moveHistory.size()) - 1) {
    // 當前索引 == 歷史記錄的最後一個索引
    // 表示已經到達最新狀態
    exitReplayMode();  // ← 自動退出！
}
```

## 按鈕狀態邏輯 (Button State Logic)

| 狀態 | currentMoveIndex | moveHistory.size() | 上一步按鈕 | 下一步按鈕 | 回放模式 |
|------|------------------|-------------------|-----------|-----------|----------|
| 初始 | -1 | 0 | ❌ 禁用 | ❌ 禁用 | ❌ 否 |
| 下了3步 | 2 | 3 | ✅ 啟用 | ❌ 禁用 | ❌ 否 |
| 回到第2步 | 1 | 3 | ✅ 啟用 | ✅ 啟用 | ✅ 是 |
| 回到第1步 | 0 | 3 | ✅ 啟用 | ✅ 啟用 | ✅ 是 |
| 回到初始 | -1 | 3 | ❌ 禁用 | ✅ 啟用 | ✅ 是 |
| 前進到第1步 | 0 | 3 | ✅ 啟用 | ✅ 啟用 | ✅ 是 |
| 前進到第2步 | 1 | 3 | ✅ 啟用 | ✅ 啟用 | ✅ 是 |
| 前進到第3步 | 2 | 3 | ✅ 啟用 | ❌ 禁用 | ❌ 否 ← 自動退出！|

## UI 元素說明 (UI Element Description)

### 1. 上一步按鈕 (Previous Move Button)
- 文字: "◄ 上一步"
- 功能: 回到上一個棋步狀態
- 啟用條件: `currentMoveIndex >= 0`
- 點擊效果:
  - 進入回放模式
  - 顯示回放模式指示
  - 禁用棋子移動

### 2. 下一步按鈕 (Next Move Button)
- 文字: "下一步 ►"
- 功能: 前進到下一個棋步狀態
- 啟用條件: `currentMoveIndex < moveHistory.size() - 1`
- 點擊效果:
  - 前進一步
  - **當到達最新狀態時自動退出回放模式** ← 核心功能
  - 隱藏回放模式指示
  - 啟用棋子移動

### 3. 回放模式指示標籤 (Replay Mode Indicator)
- 格式: "回放模式 (X/Y)"
  - X: 當前步數 (1-based)
  - Y: 總步數
- 顏色: 紅色 (#FF6B6B)
- 字體: 粗體
- 顯示條件: `isInReplayMode == true`

## 用戶體驗 (User Experience)

### ✅ 優點 (Advantages)
1. **直覺操作**: 使用簡單的前後按鈕導航
2. **視覺回饋**: 清楚顯示目前位於回放模式
3. **自動退出**: 無需手動退出，到達最新狀態自動恢復
4. **防誤操作**: 回放模式中無法移動棋子
5. **完整記錄**: 支援所有棋步類型（王車易位、吃過路兵、升變）

### 🎯 使用場景 (Use Cases)
1. **覆盤分析**: 查看之前的棋步，分析得失
2. **教學演示**: 展示特定的棋步序列
3. **錯誤檢查**: 回顧是否有走錯的棋
4. **繼續對弈**: 查看完畢後自動恢復，無縫繼續遊戲
