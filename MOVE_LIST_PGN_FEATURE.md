# 棋譜與 PGN 匯出功能

本次更新新增了棋譜顯示和 PGN (Portable Game Notation) 匯出功能。

## 新功能

### 1. 棋譜面板（Move List Panel）

在棋盤左側新增了棋譜面板，顯示所有已下的棋步：

- **位置**：棋盤左側，寬度最大 200px
- **顯示格式**：標準代數記法（Algebraic Notation）
  - 例如：`1. e4 e5`（第一步：白方 e4，黑方 e5）
  - 每行顯示一個完整的回合（白方和黑方各一步）
- **即時更新**：每次移動後自動更新
- **自動捲動**：自動捲動到最新的移動

### 2. 代數記法（Algebraic Notation）

系統自動生成標準的代數記法：

#### 基本記法
- **兵移動**：目標格子（例如：`e4`）
- **其他棋子**：棋子符號 + 目標格子（例如：`Nf3`，`Bb5`）
  - K = 國王（King）
  - Q = 皇后（Queen）
  - R = 城堡（Rook）
  - B = 主教（Bishop）
  - N = 騎士（Knight）

#### 特殊記法
- **吃子**：`x` 表示吃子（例如：`exd5`，`Nxe5`）
- **王車易位**：
  - 王翼易位：`O-O`
  - 后翼易位：`O-O-O`
- **升變**：`=` + 棋子符號（例如：`e8=Q`）
- **將軍**：`+`（例如：`Qh5+`）
- **將死**：`#`（例如：`Qh5#`）
- **吃過路兵**：使用標準吃子記法（例如：`exd6`）

#### 消歧義
當多個相同類型的棋子可以移動到同一目標時，會添加起始位置的列或行：
- **列消歧**：`Nbd2`（b 列的騎士移到 d2）
- **行消歧**：`R1a3`（第 1 行的城堡移到 a3）
- **完整消歧**：`Qh4e1`（h4 的皇后移到 e1）

### 3. PGN 匯出功能

遊戲結束後，可以將對局匯出為標準 PGN 格式：

#### 使用方法
1. 完成一局遊戲（將死、逼和或子力不足）
2. 棋譜面板下方會顯示「匯出 PGN」按鈕
3. 點擊按鈕選擇保存位置
4. 檔案將以 `.pgn` 格式保存

#### PGN 格式
匯出的 PGN 檔案包含：

```
[Event "雙人對弈"]
[Site "Qt_Chess"]
[Date "2025.11.23"]
[Round "-"]
[White "白方"]
[Black "黑方"]
[Result "1-0"]

1. e4 e5 2. Nf3 Nc6 3. Bb5 a6 4. Ba4 Nf6 5. O-O Be7
6. Re1 b5 7. Bb3 d6 8. c3 O-O 9. h3 Na5 10. Bc2 c5
... (更多移動)
1-0
```

#### 結果標記
- `1-0`：白方獲勝
- `0-1`：黑方獲勝
- `1/2-1/2`：和棋（逼和或子力不足）
- `*`：遊戲進行中（不完整對局）

## 技術實現

### 資料結構

```cpp
struct MoveRecord {
    QPoint from;              // 起始位置
    QPoint to;                // 目標位置
    PieceType pieceType;      // 棋子類型
    PieceColor pieceColor;    // 棋子顏色
    bool isCapture;           // 是否吃子
    bool isCastling;          // 是否王車易位
    bool isEnPassant;         // 是否吃過路兵
    bool isPromotion;         // 是否升變
    PieceType promotionType;  // 升變的棋子類型
    bool isCheck;             // 是否將軍
    bool isCheckmate;         // 是否將死
    QString algebraicNotation; // 代數記法字串
};
```

### 核心功能

1. **movePiece()**：每次移動時記錄棋步
2. **recordMove()**：生成並儲存 MoveRecord
3. **generateAlgebraicNotation()**：生成代數記法字串
4. **updateMoveList()**：更新 UI 顯示
5. **exportPGN()**：匯出 PGN 檔案
6. **generatePGN()**：生成 PGN 格式字串

## 使用示例

### 遊玩並匯出對局
1. 開始新遊戲
2. 進行對局，棋譜會自動記錄在左側面板
3. 完成對局（將死或其他結束條件）
4. 點擊「匯出 PGN」按鈕
5. 選擇保存位置和檔案名
6. 確認匯出成功

### 查看歷史棋步
- 在對局進行中，隨時可以在左側棋譜面板查看已下的所有棋步
- 棋步以標準記法顯示，易於閱讀和分析

## 相容性

- PGN 格式符合國際標準，可被其他象棋軟體讀取
- 代數記法使用國際通用的英文字母和符號
- 支援所有標準象棋規則和特殊移動

## 未來改進

可能的增強功能：
- 支援從 PGN 檔案載入對局
- 添加棋步註釋功能
- 提供對局分析功能
- 支援變化分支（Variations）
