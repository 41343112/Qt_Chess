# 特殊走法

## 功能概述

西洋棋包含三種特殊走法：**王車易位（Castling）**、**吃過路兵（En Passant）** 和 **兵升變（Pawn Promotion）**。Qt_Chess 完整實現了這三種特殊走法。

## 主要功能

### 1. 王車易位（Castling）

#### 功能說明
同時移動國王和城堡的特殊走法，用於保護國王並激活城堡。

#### 易位類型

**王翼易位（短易位）**
- 國王向右移動兩格
- 右側城堡跳到國王左側
- 記譜法：`O-O`

**后翼易位（長易位）**
- 國王向左移動兩格
- 左側城堡跳到國王右側
- 記譜法：`O-O-O`

#### 執行條件
所有條件必須同時滿足：
1. 國王和城堡都是首次移動
2. 國王和城堡之間沒有棋子
3. 國王當前位置未被將軍
4. 國王經過的方格未被攻擊
5. 國王到達的方格未被攻擊

#### 操作方法
1. 選擇國王
2. 向左或右移動兩格
3. 系統自動移動城堡
4. 播放特殊音效

### 2. 吃過路兵（En Passant）

#### 功能說明
兵的特殊吃子方式，當對方兵從起始位置前進兩格並停在己方兵旁邊時，可以「順道」吃掉。

#### 執行條件
1. 對方兵從起始位置前進兩格（首次移動）
2. 對方兵停在己方兵旁邊（同一列）
3. 己方兵在正確的列（白棋第5列，黑棋第4列）
4. **必須在對方移動後立即執行**（下一步）

#### 執行方式
1. 選擇己方的兵
2. 移動到對方兵"本應停留"的位置（斜前方）
3. 對方兵被移除

#### 範例
```
白棋兵在 e5
黑棋兵從 d7 → d5（前進兩格）
白棋可以 e5 → d6
黑棋 d5 的兵被吃掉
```

#### 視覺提示
- 符合條件時目標方格顯示紅色（可吃子）
- 執行後被吃兵自動移除

### 3. 兵升變（Pawn Promotion）

#### 功能說明
兵到達對面底線時，必須升變為其他棋子（皇后、城堡、主教或騎士）。

#### 升變條件
- **白兵**：到達第 0 列（最上方）
- **黑兵**：到達第 7 列（最下方）

#### 可選棋子
1. **皇后** ♕♛ - 最強大（最常選擇）
2. **城堡** ♖♜ - 直線移動
3. **主教** ♗♝ - 斜線移動
4. **騎士** ♘♞ - L形移動

**注意**：不能升變為國王或保持為兵

#### 操作流程
1. 移動兵到對面底線
2. 彈出升變選擇對話框
3. 點擊想要的棋子類型
4. 立即完成升變

#### 策略考量
- **通常選皇后**：威力最大
- **選騎士**：避免僵局或特殊戰術
- **選其他**：特定殘局需求

#### 記譜法
- `e8=Q` - 升變為皇后
- `a1=N` - 升變為騎士
- `d8=R+` - 升變為城堡並將軍

## 使用方法

### 執行王車易位
1. 確認國王和城堡未移動過
2. 清空國王和城堡之間的棋子
3. 確保國王不在被將軍狀態
4. 選擇國王並向目標方向移動兩格
5. 城堡自動移動到正確位置

### 執行吃過路兵
1. 等待對手兵從起始位置前進兩格
2. 確認己方兵在正確位置
3. **立即在下一步**選擇己方兵
4. 移動到對方兵的"虛擬"位置
5. 對方兵被吃掉

### 執行兵升變
1. 移動兵到對面底線
2. 在彈出對話框中選擇升變棋子
3. 確認選擇完成升變

## 音效與視覺

### 音效提示
- **王車易位**：特殊易位音效
- **吃過路兵**：吃子音效
- **兵升變**：移動音效 + 對話框

### 視覺提示
- **有效位置**：橙色（普通）/ 紅色（吃子）
- **升變對話框**：顯示可選棋子圖標
- **自動移動**：城堡在易位時自動移動

## 棋譜記錄

所有特殊走法都正確記錄：
- **王車易位**：`O-O` 或 `O-O-O`
- **吃過路兵**：`exd6`（標準記譜）
- **兵升變**：`e8=Q`（帶升變標記）

可匯出為標準 PGN 格式，詳見 [12_MOVE_RECORDING.md](12_MOVE_RECORDING.md)

## 技術實現

### 王車易位
```cpp
bool canCastle(bool kingSide, PieceColor color);
void performCastling(QPoint kingFrom, QPoint kingTo);
```

### 吃過路兵
```cpp
QPoint m_enPassantTarget;  // 追蹤機會
void setEnPassantTarget(QPoint target);
```

### 兵升變
```cpp
PieceType showPromotionDialog();
void promotePawn(QPoint position, PieceType newType);
```

## 相關文檔

- [01_CHESS_RULES.md](01_CHESS_RULES.md) - 基本棋規
- [08_SOUND_SETTINGS.md](08_SOUND_SETTINGS.md) - 自訂音效
- [12_MOVE_RECORDING.md](12_MOVE_RECORDING.md) - 棋譜記錄

## 程式碼參考

- `src/chessboard.cpp` - 易位和吃過路兵邏輯
- `src/chesspiece.cpp` - 移動規則驗證
- `src/qt_chess.cpp` - 升變對話框
