# 線上對戰模式

## 功能概述

Qt_Chess 支援透過中央伺服器進行網路對戰，讓您可以與世界各地的朋友對弈，無需複雜的網路設定。

## 主要功能

### 1. 中央伺服器系統

#### 伺服器特點
- **WebSocket 連接**：穩定即時通訊
- **中央伺服器**：chess-server-mjg6.onrender.com
- **無需 IP 地址**：不需要知道對方 IP
- **無需端口轉發**：不用設定路由器
- **跨網路對弈**：可與不同網路的對手連線

#### 連線方式
- 使用唯一的房號識別對局
- 自動生成房號
- 簡單的複製貼上分享

### 2. 房間系統

#### 創建房間（房主）
- 自動生成唯一房號（如：GAME-ABC123）
- 執白棋，先手
- 等待對手加入
- 一鍵複製房號

#### 加入房間（客人）
- 輸入或貼上房號
- 執黑棋，後手
- 棋盤自動翻轉
- 從剪貼簿快速貼上

### 3. 即時同步

#### 棋步同步
- 每步移動立即傳送到對手
- 自動更新棋盤狀態
- 同步特殊走法（易位、吃過路兵、升變）
- 同步認輸和遊戲結束

#### 連線狀態
- 即時顯示連線狀態
- 顯示房間資訊
- 對手斷線提示
- 自動重連嘗試

### 4. 自動配置

#### 顏色分配
- **房主**：自動執白棋
- **客人**：自動執黑棋
- 無需手動選擇

#### 視角調整
- **白棋玩家**：棋盤正常方向
- **黑棋玩家**：棋盤自動翻轉 180 度
- 符合各自視角的最佳觀看

## 使用方法

### 創建房間（房主操作）

1. **進入線上模式**
   ```
   主選單 → 點擊「線上」按鈕
   ```

2. **選擇創建房間**
   - 選擇「我要創建房間」選項

3. **取得房號**
   - 系統自動生成唯一房號
   - 點擊「複製房號」按鈕
   - 房號格式：GAME-XXXXXX

4. **分享房號**
   - 透過 LINE、WeChat、WhatsApp 等
   - 傳送房號給朋友
   - 也可以口頭告知或用其他方式

5. **等待對手**
   - 顯示「等待對手加入...」
   - 對手加入後自動開始
   - 您執白棋，先手

6. **開始對局**
   - 移動白棋開始遊戲
   - 每步自動同步到對手

### 加入房間（客人操作）

1. **進入線上模式**
   ```
   主選單 → 點擊「線上」按鈕
   ```

2. **選擇加入房間**
   - 選擇「我有房號」選項

3. **輸入房號**
   - **方法一**：點擊「從剪貼簿貼上」（推薦）
   - **方法二**：手動輸入房號
   - 確認房號格式正確

4. **連線到房間**
   - 點擊「開始」按鈕
   - 連接到伺服器
   - 顯示「連線中...」

5. **開始對局**
   - 連線成功後進入遊戲
   - 您執黑棋，棋盤自動翻轉
   - 等待白棋（房主）先手

### 對局進行

1. **輪流移動**
   - 等待自己的回合
   - 移動棋子
   - 自動傳送到對手

2. **查看對手移動**
   - 對手移動後自動更新
   - 顯示移動動畫
   - 播放音效

3. **連線監控**
   - 頂部顯示連線狀態
   - 綠色：連線正常
   - 紅色：連線中斷
   - 對手斷線會顯示提示

4. **遊戲結束**
   - 將死、僵局自動判定
   - 可使用「放棄」按鈕認輸
   - 結果同步到雙方

## 進階功能

### 斷線處理

#### 暫時斷線
- 自動嘗試重連
- 保持遊戲狀態
- 顯示「重新連線中...」

#### 對手斷線
- 顯示「對手已斷線」
- 等待對手重連
- 或選擇結束遊戲

#### 長時間斷線
- 超時後自動結束遊戲
- 保存當前棋譜

### 網路要求

#### 最低要求
- **頻寬**：極低（幾 KB/s）
- **延遲**：一般網路即可
- **穩定性**：基本穩定連線

#### 支援的網路
- ✅ 家用寬頻
- ✅ 4G/5G 行動網路
- ✅ 公司網路（通常）
- ✅ 咖啡廳 WiFi
- ⚠️ 受限制的防火牆網路（可能有問題）

### 隱私與安全

#### 房號系統
- 隨機生成，難以猜測
- 僅知道房號的人可加入
- 對局結束後房間關閉

#### 資料傳輸
- 僅傳送棋步資訊
- 不儲存個人資料
- WebSocket 加密傳輸

## 技術實現

### 網路管理
```cpp
class NetworkManager : public QObject {
    void connectToServer(const QString& serverUrl);
    void createRoom();
    void joinRoom(const QString& roomId);
    void sendMove(const QString& move);
    void disconnect();
};
```

### 訊息類型
```cpp
enum class MessageType {
    JoinRoom,      // 加入房間
    Move,          // 移動棋子
    Resign,        // 認輸
    Draw,          // 和棋
    Disconnect     // 斷線
};
```

### 連線狀態
```cpp
enum class ConnectionStatus {
    Disconnected,  // 未連線
    Connecting,    // 連線中
    Connected,     // 已連線
    InGame         // 遊戲中
};
```

## 相關文檔

- [03_GAME_MODES.md](03_GAME_MODES.md) - 遊戲模式介紹
- [06_TIME_CONTROL.md](06_TIME_CONTROL.md) - 線上對局的時間控制
- [12_MOVE_RECORDING.md](12_MOVE_RECORDING.md) - 線上對局的棋譜記錄

## 程式碼參考

- `src/networkmanager.h/cpp` - 網路連線管理
- `src/onlinedialog.h/cpp` - 線上對話框 UI
- `src/qt_chess.cpp` - 線上模式整合
- `server.js` - 伺服器端程式碼

## 疑難排解

### 無法連線到伺服器
- 檢查網路連線
- 確認伺服器狀態
- 嘗試重啟應用程式
- 檢查防火牆設定

### 房號無效
- 確認房號格式正確（GAME-XXXXXX）
- 檢查是否複製完整
- 注意大小寫（不區分）
- 確認房間仍然存在

### 頻繁斷線
- 檢查網路穩定性
- 嘗試切換網路
- 確認對手網路狀況
- 降低背景網路使用

### 對手無法加入
- 確認房號正確分享
- 檢查雙方網路連線
- 嘗試重新創建房間
- 確認伺服器運作正常
