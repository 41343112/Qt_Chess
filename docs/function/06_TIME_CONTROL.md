# 時間控制

## 功能概述

Qt_Chess 提供完整的時間控制系統，支援從快棋到慢棋的各種時間設定，包括總時間限制和每著加秒（增量）功能。

## 主要功能

### 1. 總時間設定

#### 時間選項
- **無限制**：不限時，適合學習和分析
- **30 秒**：極快閃電戰
- **1 分鐘**：快速閃電戰
- **3 分鐘**：標準閃電戰（Bullet）
- **5 分鐘**：快速賽（Blitz）
- **10 分鐘**：快棋（Rapid）
- **15 分鐘**：快棋
- **30 分鐘**：標準賽
- **45 分鐘**：長時賽
- **60 分鐘**：經典賽

#### 時間分配
- 每位玩家獲得相同的總時間
- 時間從第一步開始計時
- 計時器持續倒數直到時間用完

### 2. 每著加秒（增量）

#### 功能說明
每走一步棋後，自動增加指定秒數到玩家時間。

#### 增量選項
- **0 秒**：無增量（傳統模式）
- **1-60 秒**：可調整增量

#### 常見組合
- **3 分鐘 + 2 秒**：標準閃電戰
- **5 分鐘 + 3 秒**：快速賽
- **10 分鐘 + 5 秒**：快棋
- **15 分鐘 + 10 秒**：長快棋

#### 增量時機
- 完成移動後立即增加
- 適用於所有模式（雙人、AI、線上）
- 防止時間完全耗盡

### 3. 計時器顯示

#### 視覺呈現
- **雙計時器**：白棋和黑棋各一個
- **位置**：棋盤兩側
- **格式**：MM:SS（分鐘:秒數）
- **顏色區分**：清楚標示白/黑

#### 回合指示
- **綠色背景**：當前輪到的玩家
- **普通背景**：等待中的玩家
- **紅色閃爍**：時間不足警告（最後 10 秒）

#### 即時更新
- 每秒更新顯示
- 精確到秒
- 流暢倒數

### 4. 超時判定

#### 超時規則
- 時間歸零視為超時
- 超時方自動判負
- 對手獲勝

#### 超時提示
- 顯示「超時！」訊息
- 遊戲立即結束
- 結果記錄在棋譜中

## 使用方法

### 設定時間控制

1. **開始遊戲前設定**
   ```
   選擇遊戲模式 → 設定時間控制
   ```

2. **選擇總時間**
   - 在「總時間」下拉選單選擇
   - 或選擇「無限制」

3. **設定每著加秒**
   - 拖動「每著加秒」滑桿
   - 範圍：0-60 秒
   - 顯示當前秒數

4. **確認設定**
   - 設定會立即應用
   - 自動儲存，下次啟動時保留

### 遊戲中使用

1. **開始計時**
   - 第一步棋走出後開始
   - 輪到的玩家計時器倒數
   - 對手計時器暫停

2. **移動棋子**
   - 在自己時間內完成移動
   - 移動後時間停止
   - 獲得增量時間（如有設定）

3. **監控時間**
   - 注意計時器顏色
   - 綠色背景 = 您的回合
   - 時間不足時加快速度

4. **時間管理**
   - 合理分配時間
   - 開局可快速行棋
   - 關鍵時刻多思考

### 不同模式下的時間控制

#### 雙人模式
- 雙方共用時間設定
- 輪流計時
- 公平競爭

#### AI 模式
- 玩家和電腦各自計時
- 電腦受時間限制
- 電腦會考慮剩餘時間

#### 線上模式
- 時間同步到伺服器
- 雙方看到相同時間
- 斷線時間繼續計時（需注意）

## 進階功能

### 時間控制策略

#### 快棋技巧（3-5 分鐘）
- 快速開局，使用熟悉的開局
- 避免長考
- 保留時間應對中盤複雜局面

#### 標準賽技巧（10-30 分鐘）
- 開局可適當思考
- 中盤複雜時多用時間
- 殘局注意時間管理

#### 增量使用
- 有增量時可稍微多思考
- 避免依賴增量
- 保持時間緩衝

### 時間壓力處理

#### 時間充裕（剩餘 > 50%）
- 正常速度思考
- 可以深入計算
- 不用急躁

#### 時間緊張（剩餘 < 30%）
- 加快行棋速度
- 避免複雜局面
- 簡化局勢

#### 時間危機（剩餘 < 10 秒）
- 快速移動
- 依靠直覺
- 利用增量時間

### 回放模式中的計時器

#### 自動暫停
- 進入回放模式時計時器暫停
- 防止回放時浪費時間
- 保護遊戲公平性

#### 恢復計時
- 退出回放模式時恢復
- 時間從暫停處繼續
- 不會遺失時間

詳見 [12_MOVE_RECORDING.md](12_MOVE_RECORDING.md)

## 設定儲存

### 自動儲存
- 時間設定自動儲存
- 關閉程式後保留
- 下次啟動時恢復

### 儲存位置
使用 Qt Settings 儲存：
- Linux: `~/.config/Qt_Chess/`
- Windows: 註冊表
- macOS: `~/Library/Preferences/`

## 技術實現

### 計時器管理
```cpp
QTimer* m_whiteTimer;
QTimer* m_blackTimer;
int m_whiteTimeMs;  // 白棋剩餘時間（毫秒）
int m_blackTimeMs;  // 黑棋剩餘時間（毫秒）
int m_incrementMs;  // 增量時間（毫秒）
```

### 時間更新
```cpp
void updateTimer() {
    if (currentPlayer == White) {
        m_whiteTimeMs -= 1000;  // 減少 1 秒
        if (m_whiteTimeMs <= 0) {
            handleTimeout(White);
        }
    }
    updateTimerDisplay();
}
```

### 增量處理
```cpp
void onMoveMade() {
    stopCurrentTimer();
    addIncrement(currentPlayer);
    switchPlayer();
    startCurrentTimer();
}

void addIncrement(PieceColor player) {
    if (player == White) {
        m_whiteTimeMs += m_incrementMs;
    } else {
        m_blackTimeMs += m_incrementMs;
    }
}
```

### 時間格式化
```cpp
QString formatTime(int milliseconds) {
    int minutes = milliseconds / 60000;
    int seconds = (milliseconds % 60000) / 1000;
    return QString("%1:%2")
        .arg(minutes)
        .arg(seconds, 2, 10, QChar('0'));
}
```

## 相關文檔

- [03_GAME_MODES.md](03_GAME_MODES.md) - 各模式的時間控制
- [04_AI_COMPUTER_PLAY.md](04_AI_COMPUTER_PLAY.md) - AI 模式時間
- [05_ONLINE_MODE.md](05_ONLINE_MODE.md) - 線上模式時間同步
- [12_MOVE_RECORDING.md](12_MOVE_RECORDING.md) - 回放時的計時器

## 程式碼參考

- `src/qt_chess.h/cpp` - 計時器實現
- `src/chessboard.cpp` - 時間判定邏輯

## 疑難排解

### 計時器不更新
- 確認已開始遊戲
- 檢查是否在回放模式
- 重新開始遊戲

### 時間設定未保存
- 確認有寫入權限
- 檢查設定檔位置
- 嘗試重新設定

### 超時判定錯誤
- 確認時間確實歸零
- 檢查系統時間準確性
- 重啟應用程式
