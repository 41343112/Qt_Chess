# 線上對戰模式功能

## 功能概述

線上對戰模式允許兩位玩家通過網路連線在不同裝置上進行對弈。使用簡單的4位數字房號系統，讓玩家可以輕鬆創建和加入遊戲房間。

## 主要特色

- **4位數字房號**: 自動生成的房號（1000-9999）便於記憶和分享
- **簡易連線**: 房主創建房間，對手輸入IP地址和房號即可加入
- **自動同步**: 棋步自動在兩位玩家間同步傳輸
- **即時狀態**: 顯示連線狀態、等待對手、遊戲進行中等狀態
- **自動配色**: 房主執白棋，加入者執黑棋
- **棋盤自動翻轉**: 黑棋玩家的棋盤會自動翻轉，使黑棋在下方

## 使用方法

### 創建房間（作為房主）

1. 點擊時間控制面板中的 **🌐 線上** 按鈕
2. 在彈出的對話框中選擇 **"創建房間（作為房主）"**
3. 點擊 **"確定"**
4. 系統會顯示房間資訊對話框，包含：
   - **房間號碼**: 4位數字房號
   - **您的IP地址**: 自動偵測的本機IP地址
   - **端口**: 自動計算的端口號（10000 + 房號）
5. 將房號和IP地址告訴對手
6. 等待對手加入（畫面會顯示 "🔄 等待對手加入..."）
7. 對手加入後，遊戲自動開始

### 加入房間

1. 點擊時間控制面板中的 **🌐 線上** 按鈕
2. 在彈出的對話框中選擇 **"加入房間"**
3. 輸入房主提供的資訊：
   - **對方IP地址**: 房主的IP地址（例如: 192.168.1.100）
   - **房間號碼**: 4位數字房號
4. 點擊 **"確定"**
5. 系統會嘗試連接房主（畫面會顯示 "🔄 正在連接..."）
6. 連接成功後，遊戲自動開始

## 遊戲流程

1. **房主執白棋先走**: 創建房間的玩家自動獲得白棋
2. **加入者執黑棋**: 加入房間的玩家自動獲得黑棋
3. **輪流下棋**: 必須等待對手完成移動後才能移動
4. **自動同步**: 每一步棋會自動傳送給對手
5. **斷線處理**: 如果對手斷線，會收到通知並返回雙人模式

## 連線狀態說明

遊戲中會顯示以下連線狀態：

- **🔄 等待對手加入...**: 房主正在等待對手連接
- **🔄 正在連接...**: 加入者正在嘗試連接房主
- **✅ 已連接**: 連線建立成功
- **✅ 對手已加入**: 對手成功加入房間
- **✅ 遊戲開始**: 雙方都準備好，遊戲開始
- **❌ 已斷線**: 連線中斷
- **❌ 連線錯誤**: 連線發生錯誤

## 技術規格

### 網路架構

- **協議**: TCP/IP
- **架構**: 客戶端-服務器模式
- **房主角色**: 服務器（監聽連線）
- **加入者角色**: 客戶端（主動連接）

### 端口分配

- **計算公式**: 端口 = 10000 + 房間號碼
- **範圍**: 11000 - 19999
- **例子**: 房號 1234 對應端口 11234

### 訊息格式

使用 JSON 格式傳輸遊戲事件：

```json
{
  "type": "Move",
  "fromRow": 6,
  "fromCol": 4,
  "toRow": 4,
  "toCol": 4,
  "promotion": 5
}
```

### 支援的訊息類型

- **JoinRoom**: 加入房間請求
- **JoinAccepted**: 加入被接受
- **GameStart**: 遊戲開始
- **Move**: 棋步移動
- **GameOver**: 遊戲結束
- **PlayerDisconnected**: 玩家斷線

## 網路需求

### 區域網路（LAN）連線

- 兩台裝置必須在同一個網路中
- 無需額外設置，直接使用本機IP地址

### 跨網路連線

- 房主需要設置端口轉發（Port Forwarding）
- 需要知道房主的公網IP地址
- 可能需要在路由器中開放對應端口

### 防火牆設置

如果無法連線，請檢查：
1. 防火牆是否阻擋應用程式
2. 是否允許應用程式使用網路
3. 端口是否被其他程式佔用

## 常見問題

### Q: 無法連接到房主

**A**: 請檢查：
1. IP地址是否正確
2. 房號是否正確
3. 兩台裝置是否在同一網路中
4. 防火牆設置是否正確
5. 房主的應用程式是否正在運行

### Q: 對手突然斷線

**A**: 可能的原因：
1. 網路連線中斷
2. 應用程式崩潰
3. 裝置關閉
4. 網路不穩定

系統會自動偵測斷線並顯示通知。

### Q: 如何獲取本機IP地址？

**A**: 
- Windows: 在命令提示字元中輸入 `ipconfig`
- Mac/Linux: 在終端機中輸入 `ifconfig` 或 `ip addr`
- 應用程式會自動顯示偵測到的IP地址

### Q: 可以同時開啟多個房間嗎？

**A**: 目前一個應用程式實例只能參與一個遊戲。如果要同時進行多場遊戲，需要開啟多個應用程式視窗。

### Q: 遊戲中可以切換模式嗎？

**A**: 在線上遊戲進行中，不建議切換模式。如果需要結束線上遊戲，請先認輸或等待遊戲結束。

## 安全注意事項

1. **僅在信任的網路中使用**: 建議在私人或安全的網路環境中使用此功能
2. **不要分享敏感資訊**: 遊戲通訊不加密，請勿通過遊戲分享敏感資訊
3. **防火牆保護**: 確保防火牆已啟用，保護您的裝置安全
4. **公網使用謹慎**: 如果使用公網IP連線，請確保了解相關風險

## 開發者資訊

### 類別結構

- **NetworkManager**: 處理網路通訊
  - 管理TCP套接字連線
  - 處理訊息序列化/反序列化
  - 發送和接收遊戲事件
  
- **OnlineDialog**: 線上模式UI對話框
  - 提供創建/加入房間選項
  - 收集連線資訊（IP、房號）
  - 輸入驗證

### 關鍵方法

```cpp
// 創建房間
bool NetworkManager::createRoom(quint16 port = 0);

// 加入房間
bool NetworkManager::joinRoom(const QString& hostAddress, quint16 port);

// 發送移動
void NetworkManager::sendMove(const QPoint& from, const QPoint& to, PieceType promotionType);

// 關閉連線
void NetworkManager::closeConnection();
```

### 信號

```cpp
// 連線相關
void connected();
void disconnected();
void connectionError(const QString& error);

// 房間相關
void roomCreated(const QString& roomNumber, quint16 port);
void opponentJoined();
void opponentDisconnected();

// 遊戲相關
void opponentMove(const QPoint& from, const QPoint& to, PieceType promotionType);
void gameStartReceived(PieceColor playerColor);
void gameOverReceived(const QString& result);
```

## 未來改進方向

1. **加密通訊**: 實現訊息加密保護隱私
2. **房間瀏覽**: 提供可用房間列表
3. **觀戰模式**: 允許其他玩家觀看對局
4. **聊天功能**: 加入文字聊天功能
5. **遊戲記錄**: 自動儲存線上對局記錄
6. **重連機制**: 斷線後自動重連
7. **匹配系統**: 自動匹配相近等級的玩家
8. **排名系統**: 追蹤玩家勝率和等級

## 授權

此功能作為 Qt_Chess 專案的一部分，遵循相同的授權條款。
