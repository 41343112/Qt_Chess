# 霧戰模式實現文檔

## 概述

霧戰（Fog of War）模式已成功實現。在此模式下，雙方玩家只能看到自己棋子可移動範圍內的視野，其餘視野都是不清楚的（顯示為霧狀效果）。

## 功能特點

### 1. 視野計算
- 玩家可以看到自己所有棋子所在的位置
- 玩家可以看到自己所有棋子可以移動到的位置
- 其他位置顯示為霧狀（深灰色背景 + 霧狀符號 🌫）

### 2. 不同模式下的視角

#### 線上對戰模式
- 每個玩家只看到自己顏色的視角
- 房主看到其選擇顏色的視角
- 房客看到對立顏色的視角
- 視角不會因為輪次改變而切換

#### 本地對戰模式
- 視角根據當前輪次切換
- 白方回合時顯示白方視角
- 黑方回合時顯示黑方視角
- 適合兩人在同一台電腦上對弈

## 技術實現

### 新增的方法

#### ChessBoard 類 (chessboard.h/cpp)

```cpp
std::vector<QPoint> getVisibleSquaresForColor(PieceColor color) const;
```
- 計算指定顏色玩家可見的所有方格
- 遍歷該顏色的所有棋子
- 對每個棋子，檢查其所有合法移動位置
- 返回所有可見方格的列表

#### Qt_Chess 類 (qt_chess.h/cpp)

```cpp
bool isFogOfWarEnabled() const;
```
- 檢查是否啟用了霧戰模式
- 檢查 `m_selectedGameModes["霧戰"]` 的值

```cpp
bool isSquareVisibleInFogOfWar(int logicalRow, int logicalCol, PieceColor viewingPlayer) const;
```
- 檢查指定方格對於指定玩家是否可見
- 調用 `ChessBoard::getVisibleSquaresForColor()` 獲取可見方格列表
- 檢查當前方格是否在列表中

```cpp
void displayPieceOnSquare(QPushButton* square, const ChessPiece& piece, bool isVisible);
```
- 重載的方法，增加了可見性參數
- 當 `isVisible = false` 時，顯示霧狀符號 🌫
- 當 `isVisible = true` 時，正常顯示棋子

### 修改的方法

#### updateBoard()
- 檢查是否啟用霧戰模式
- 根據遊戲模式決定視角玩家顏色
- 對每個方格，檢查是否可見
- 使用新的 `displayPieceOnSquare()` 方法顯示棋子

#### updateSquareColor()
- 檢查是否啟用霧戰模式
- 對於不可見的方格，使用深灰色背景 (RGB: 50, 50, 60)
- 對於可見的方格，使用正常的棋盤顏色

## 視覺效果

### 可見方格
- 正常的棋盤顏色（淺色/深色交替）
- 顯示實際的棋子圖標或符號

### 不可見方格（霧狀）
- 深灰藍色背景 (RGB: 50, 50, 60)
- 顯示霧狀符號 🌫
- 灰色文字顏色

## 使用方法

1. 在創建線上房間時，勾選「🌫️ 霧戰」選項
2. 開始遊戲後，玩家將只能看到自己棋子的視野範圍
3. 隨著棋子移動，視野會動態更新
4. 對方的棋子只有在你的棋子視野範圍內時才可見

## 注意事項

1. **移動合法性**：即使看不到對方的棋子，遊戲規則仍然正常運作。例如，如果你的國王被將軍，即使你看不到對方的攻擊棋子，你也必須解除將軍狀態。

2. **視野更新**：視野會在每次棋盤更新時重新計算，包括：
   - 棋子移動後
   - 輪次切換後（本地模式）
   - 選擇棋子時（高亮有效移動）

3. **其他模式不受影響**：如果沒有選擇霧戰模式，遊戲將正常顯示所有棋子，不會有任何霧狀效果。

## 測試建議

### 本地測試
1. 開始新遊戲
2. 在遊戲模式對話框中選擇「霧戰」
3. 觀察白方視角（只能看到白方棋子及其可移動範圍）
4. 移動白棋後，視角切換到黑方
5. 觀察黑方視角（只能看到黑方棋子及其可移動範圍）

### 線上測試
1. 創建房間並選擇「霧戰」模式
2. 另一玩家加入房間
3. 開始遊戲
4. 房主（白方）應只能看到白方視野
5. 房客（黑方）應只能看到黑方視野
6. 測試棋子移動後視野的更新

## 已知限制

1. 目前霧戰模式主要在線上對戰中使用，因為本地模式下兩個玩家使用同一個螢幕，視角會切換。
2. 被吃掉的棋子顯示不受霧戰模式影響（仍然會顯示所有被吃掉的棋子）。

## 未來改進

1. 可以考慮在霧戰模式下隱藏被吃掉的棋子顯示
2. 可以添加更多視覺效果，如漸變的霧狀邊界
3. 可以添加設定選項來自訂霧的顏色和透明度
