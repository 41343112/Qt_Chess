# 特殊走法說明

## 概述

西洋棋除了基本的棋子移動規則外，還包含三種特殊走法：**王車易位（Castling）**、**吃過路兵（En Passant）** 和 **兵升變（Pawn Promotion）**。Qt_Chess 完整實現了這三種特殊走法。

## 王車易位（Castling）

### 什麼是王車易位？

王車易位是唯一可以同時移動兩個棋子的走法，讓國王和城堡同時移動，用於保護國王並激活城堡。

### 王車易位的類型

#### 王翼易位（Short Castling / Kingside Castling）

- 國王向右移動兩格
- 右側城堡跳過國王到其左側
- 記譜法：**O-O**

#### 后翼易位（Long Castling / Queenside Castling）

- 國王向左移動兩格
- 左側城堡跳過國王到其右側
- 記譜法：**O-O-O**

### 執行王車易位的條件

所有以下條件都必須滿足：

1. **首次移動**
   - 國王和參與易位的城堡都必須是第一次移動
   - 任何一方移動過就永久失去易位的權利

2. **路徑暢通**
   - 國王和城堡之間不能有任何棋子

3. **國王安全**
   - 國王當前位置不能處於被將軍狀態
   - 國王經過的方格不能被對方攻擊
   - 國王最終到達的方格不能被對方攻擊

4. **城堡存在**
   - 參與易位的城堡必須還在棋盤上（未被吃掉）

### 如何執行王車易位

在 Qt_Chess 中執行王車易位：

1. 選擇國王
2. 點擊或拖曳國王到目標位置（左移或右移兩格）
3. 遊戲會自動驗證條件
4. 如果合法，城堡會自動移動到正確位置

### 視覺提示

- 可以進行王車易位時，目標方格會顯示為有效移動（橙色）
- 國王移動後，城堡會自動移動到新位置
- 播放特殊的王車易位音效

## 吃過路兵（En Passant）

### 什麼是吃過路兵？

吃過路兵是兵的特殊吃子方式，當對方的兵從起始位置前進兩格並停在己方兵的旁邊時，己方兵可以「順道」吃掉對方的兵。

### 執行條件

1. **對方兵的移動**
   - 對方的兵必須從起始位置（第 2 列或第 7 列）前進兩格
   - 這必須是該兵的第一次移動

2. **位置關係**
   - 對方兵前進後必須停在己方兵的旁邊（同一列）
   - 己方兵必須在第 5 列（白棋）或第 4 列（黑棋）

3. **時機限制**
   - **必須在對方兵移動後的下一步立即執行**
   - 錯過這個時機就無法再吃過路兵

### 執行方式

1. 選擇己方的兵
2. 移動到對方兵"本應停留"的位置（斜前方）
3. 對方的兵會被移除（雖然不在目標方格上）

### 範例

```
白棋兵在 e5
黑棋兵從 d7 移動到 d5（前進兩格）
白棋可以將 e5 的兵移動到 d6
黑棋 d5 的兵會被吃掉
```

### 在 Qt_Chess 中的實現

- 遊戲會自動追蹤吃過路兵的機會
- 符合條件時，目標方格會顯示為可吃子位置（紅色）
- 執行後，被吃的兵會自動從棋盤上移除

## 兵升變（Pawn Promotion）

### 什麼是兵升變？

當兵到達棋盤的對面底線時，必須升變為其他更強大的棋子（皇后、城堡、主教或騎士）。

### 升變條件

- **白兵**：到達第 0 列（黑棋底線）
- **黑兵**：到達第 7 列（白棋底線）

### 可升變的棋子

玩家可以選擇升變為：

1. **皇后（Queen）** ♕♛ - 最常選擇，最強大的棋子
2. **城堡（Rook）** ♖♜ - 直線移動
3. **主教（Bishop）** ♗♝ - 斜線移動
4. **騎士（Knight）** ♘♞ - L 形移動

**注意**：不能升變為國王或保持為兵。

### 升變流程

在 Qt_Chess 中：

1. 將兵移動到對面底線
2. 自動彈出升變選擇對話框
3. 點擊想要升變的棋子類型
4. 兵會立即變成選擇的棋子

### 升變對話框

升變對話框包含：
- 四個按鈕，分別顯示皇后、城堡、主教、騎士的圖標
- 清晰的提示訊息
- 使用與遊戲一致的棋子圖標（如果有自訂圖標）

### 策略考量

雖然大多數情況下升變為皇后是最佳選擇，但某些特殊情況下可能需要選擇其他棋子：

- **騎士**：避免造成僵局，或利用騎士的特殊移動能力
- **城堡或主教**：某些殘局中的戰術需求
- **避免僵局**：升變為皇后可能導致對手僵局，選擇較弱的棋子可以避免

### 記譜法

兵升變在棋譜中的表示：
- `e8=Q` - e 兵到達 e8 並升變為皇后
- `a1=N` - a 兵到達 a1 並升變為騎士
- `d8=R+` - d 兵到達 d8 升變為城堡並將軍

## 特殊走法的音效

Qt_Chess 為特殊走法提供了不同的音效：

- **王車易位**：特殊的易位音效（不同於普通移動）
- **吃過路兵**：吃子音效（與普通吃子相同）
- **兵升變**：移動音效（升變對話框有視覺提示）

音效可以在「設定」→「音效設定」中自訂。詳見 [SOUND_SETTINGS.md](SOUND_SETTINGS.md)

## 棋譜記錄

所有特殊走法都會正確記錄在棋譜中：

- **王車易位**：`O-O`（王翼）或 `O-O-O`（后翼）
- **吃過路兵**：`exd6`（例如：e5 的兵吃 d6 過路）
- **兵升變**：`e8=Q`（例如：升變為皇后）

棋譜可以匯出為標準 PGN 格式。詳見 [MOVE_LIST_PGN_FEATURE.md](MOVE_LIST_PGN_FEATURE.md)

## 技術實現細節

### 王車易位

```cpp
// 檢查王車易位條件
bool canCastle(bool kingSide, PieceColor color);

// 執行王車易位時自動移動城堡
void performCastling(QPoint kingFrom, QPoint kingTo);
```

### 吃過路兵

```cpp
// 追蹤吃過路兵的機會
QPoint m_enPassantTarget;

// 在對方兵前進兩格後設定
void setEnPassantTarget(QPoint target);
```

### 兵升變

```cpp
// 顯示升變對話框
PieceType showPromotionDialog();

// 執行升變
void promotePawn(QPoint position, PieceType newType);
```

## 相關文檔

- [西洋棋規則與實現](CHESS_RULES.md) - 基本規則說明
- [音效設定](SOUND_SETTINGS.md) - 自訂特殊走法音效
- [棋譜記錄與回放](REPLAY_FEATURE.md) - 查看和重播特殊走法

## 程式碼參考

主要實現文件：
- `src/chessboard.cpp` - `canCastle()`, `performCastling()`, `isEnPassantCapture()`
- `src/chesspiece.cpp` - `isValidMove()` 中的特殊走法驗證
- `src/qt_chess.cpp` - 兵升變對話框實現
