# 西洋棋規則與實現

## 概述

Qt_Chess 實現了完整的國際西洋棋規則（FIDE rules），包括所有標準棋子的移動規則、特殊走法、將軍檢測和遊戲結束條件判定。

## 棋子與移動規則

### 兵（Pawn）♙♟

- **基本移動**：向前移動一格
- **首次移動**：從起始位置可以向前移動兩格
- **吃子**：斜向吃子（向前斜進一格）
- **特殊規則**：
  - 只能向前移動，不能後退
  - 到達對面底線時必須升變
  - 支援吃過路兵（En Passant）

### 城堡（Rook）♖♜

- **移動方向**：水平或垂直方向
- **移動距離**：任意格數
- **路徑要求**：移動路徑上不能有其他棋子阻擋
- **特殊規則**：可參與王車易位

### 騎士（Knight）♘♞

- **移動模式**：「L」形移動
  - 一個方向移動 2 格，垂直方向移動 1 格
  - 或一個方向移動 1 格，垂直方向移動 2 格
- **特殊能力**：可以跳過其他棋子
- **移動範圍**：最多可到達 8 個不同位置

### 主教（Bishop）♗♝

- **移動方向**：斜向移動
- **移動距離**：任意格數
- **路徑要求**：移動路徑上不能有其他棋子阻擋
- **特性**：始終停留在同一顏色的方格上

### 皇后（Queen）♕♛

- **移動方向**：水平、垂直或斜向
- **移動距離**：任意格數
- **路徑要求**：移動路徑上不能有其他棋子阻擋
- **特性**：結合了城堡和主教的移動能力

### 國王（King）♔♚

- **移動方向**：任何方向（水平、垂直、斜向）
- **移動距離**：一次只能移動一格
- **限制**：不能移動到會被將軍的位置
- **特殊規則**：可參與王車易位

## 遊戲規則

### 回合制

- 白棋先走
- 雙方輪流下棋
- 每回合只能移動一個棋子（王車易位除外）

### 走法驗證

遊戲會自動驗證每一步移動是否合法：

1. **基本規則檢查**
   - 移動是否符合該棋子的移動規則
   - 目標位置是否在棋盤範圍內
   - 目標位置是否被己方棋子佔據

2. **路徑檢查**
   - 對於城堡、主教和皇后，檢查移動路徑是否有棋子阻擋
   - 騎士可以跳過其他棋子

3. **將軍檢查**
   - 移動後己方國王不能處於被將軍狀態
   - 如果己方國王已被將軍，移動必須解除將軍狀態

### 將軍（Check）

- 當國王受到對方棋子的直接威脅時，稱為「將軍」
- 被將軍時必須：
  1. 移動國王到安全位置
  2. 用其他棋子阻擋攻擊路線
  3. 吃掉攻擊國王的棋子
- 遊戲會自動檢測將軍狀態並顯示提示

### 將死（Checkmate）

- 當國王被將軍且無法逃脫時，遊戲結束
- 被將死的一方輸掉遊戲
- 將死判定條件：
  - 國王處於被將軍狀態
  - 國王無法移動到安全位置
  - 無法用其他棋子阻擋或吃掉攻擊者

### 僵局（Stalemate）

- 輪到某方行動但沒有任何合法移動，且國王未被將軍
- 僵局導致平局（和棋）

### 其他平局規則

本實現支援以下平局情況：

- **僵局**：無合法移動且未被將軍
- **材料不足**：
  - 單國王對單國王
  - 國王+主教對國王
  - 國王+騎士對國王

## 視覺化提示

### 棋子選擇與移動標示

- **選中棋子**：點擊己方棋子後，該棋子會被高亮顯示
- **有效移動**：
  - **橙色方格**：可以移動到的空位
  - **紅色方格**：可以吃子的位置
- **上一步移動**：
  - 上一步移動的起始和目標方格會有視覺標示
  - 幫助玩家追蹤對手的移動

### 互動方式

1. **點擊移動**
   - 點擊要移動的棋子
   - 點擊目標位置

2. **拖放移動**
   - 點擊並拖曳棋子
   - 釋放到目標位置

3. **取消操作**
   - 再次點擊已選中的棋子
   - 按滑鼠右鍵取消拖曳

## 技術實現

### 核心類別

- **ChessPiece**：棋子類別，定義棋子類型、顏色和移動規則
- **ChessBoard**：棋盤類別，管理遊戲狀態和規則驗證
- **Qt_Chess**：主視窗類別，處理 UI 互動和視覺呈現

### 移動驗證流程

```
使用者操作
    ↓
基本規則檢查（棋子移動規則）
    ↓
路徑檢查（是否有阻擋）
    ↓
將軍檢查（移動後是否安全）
    ↓
執行移動或拒絕
```

### 特殊走法處理

特殊走法（王車易位、吃過路兵、兵升變）的詳細說明請參閱 [SPECIAL_MOVES.md](SPECIAL_MOVES.md)

## 遊戲狀態追蹤

遊戲會自動追蹤以下狀態：

- 當前輪到哪一方
- 每個棋子是否已移動過（用於王車易位和兵的首次移動）
- 吃過路兵的機會
- 遊戲結果（進行中、將死、僵局、投降）

## 相關文檔

- [特殊走法說明](SPECIAL_MOVES.md) - 王車易位、吃過路兵、兵升變
- [棋譜記錄與回放](REPLAY_FEATURE.md) - 記錄和重播對局
- [AI 人機對弈](AI_COMPUTER_PLAY.md) - 與電腦對弈

## 程式碼參考

主要實現文件：
- `src/chesspiece.h/cpp` - 棋子定義和移動規則
- `src/chessboard.h/cpp` - 棋盤邏輯和遊戲規則
- `src/qt_chess.h/cpp` - UI 邏輯和視覺呈現
