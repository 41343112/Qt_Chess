# 網路對戰功能使用說明

## 功能概述

Qt_Chess 現在支援網路對戰功能，允許兩個玩家通過 TCP/IP 網路連線進行對弈。無論玩家是在同一局域網內還是跨越不同網域，只要能夠建立網路連線，就可以進行對戰。

## 功能特點

- **點對點連線**：使用 TCP 協議建立穩定的點對點連線
- **主機/客戶端模式**：一方作為主機（伺服器）等待連線，另一方作為客戶端連接
- **房間號碼系統**：自動生成包含 IP 和端口的房間號碼，方便跨網域連線
- **即時棋步同步**：所有移動即時同步到對手
- **選邊功能**：主機可以選擇執白或執黑
- **連線狀態顯示**：即時顯示連線狀態和對手資訊
- **認輸同步**：認輸訊息即時傳送給對手
- **新遊戲請求**：可以向對手發送新遊戲請求

## 使用方法

### 1. 主機模式（等待其他玩家連線）

1. 啟動遊戲
2. 在右側控制面板選擇「🌐 網路」模式
3. 在彈出的對話框中選擇「主機模式」
4. 設定以下選項：
   - **玩家名稱**：輸入您的名稱
   - **執棋顏色**：選擇執白或執黑
5. 系統會自動生成一個 10 位數的房間號碼（例如：71P11Q99PS）
6. 點擊「複製」按鈕複製房間號碼
7. 將房間號碼傳送給您的對手（透過聊天軟體、電子郵件等）
8. 點擊「開始」按鈕
9. 等待對手輸入房間號碼並連線
10. 當對手連線成功後，遊戲即可開始

**房間號碼說明：**
- 房間號碼是一個 10 位字符串，自動編碼了您的 IP 位址和端口
- 支援跨網域連線，對手在任何地方都可以通過房間號碼連接到您
- 房間號碼使用 Base32 編碼，避免易混淆的字符（0、O、I、L）

**注意事項：**
- 確保防火牆允許指定端口的連線
- 如果對手在不同網域（互聯網），可能需要設定路由器的端口轉發

### 2. 客戶端模式（連接到其他玩家）

1. 啟動遊戲
2. 在右側控制面板選擇「🌐 網路」模式
3. 在彈出的對話框中選擇「加入模式」
4. 設定以下選項：
   - **玩家名稱**：輸入您的名稱
   - **房間號碼**：輸入主機提供的 10 位房間號碼
5. 點擊「開始」按鈕
6. 等待連線建立
7. 連線成功後，遊戲即可開始

### 3. 進行對弈

- 連線成功後，按照正常的西洋棋規則進行對弈
- 只能在輪到自己時移動棋子
- 所有移動會即時同步到對手的棋盤
- 可以使用「放棄」按鈕認輸
- 可以使用「新遊戲」按鈕請求開始新遊戲

### 4. 結束對戰

- 遊戲結束後，可以選擇：
  - 切換回其他模式（會自動斷開連線）
  - 請求新遊戲繼續對弈
  - 關閉應用程式

## 網路設定

### 房間號碼系統

從新版本開始，Qt_Chess 使用房間號碼系統簡化連線過程：

- **自動編碼**：房間號碼自動包含主機的 IP 位址和端口資訊
- **跨網域支援**：房間號碼可以在任何網路環境下使用
- **簡化分享**：只需複製並分享一個 10 位數的房間號碼

### 同一局域網內對戰

如果兩個玩家在同一局域網內（例如同一 WiFi 網路）：
1. 主機生成房間號碼
2. 房間號碼會自動編碼局域網 IP（如 192.168.x.x）
3. 客戶端輸入房間號碼即可連線

### 跨網域對戰

#### 方式一：使用房間號碼 + 端口轉發（推薦）

1. 主機需要設定路由器的端口轉發：
   - 登入路由器管理頁面
   - 找到端口轉發或虛擬伺服器設定
   - 新增轉發規則：將外部端口轉發到主機的內部 IP 和端口
   - 端口號可以在房間號碼生成後查看（顯示在「本機 IP」下方）
   - 保存設定

2. 確認路由器已開啟端口轉發後：
   - 主機生成的房間號碼會自動編碼局域網 IP
   - 如果需要跨網域連線，主機需要告知對手進行端口轉發
   - 或者，主機可以手動獲取公網 IP 並重新生成包含公網 IP 的房間號碼

3. 客戶端輸入房間號碼即可連線

**注意**：當前版本的房間號碼會編碼主機的局域網 IP。如果需要跨網域連線，主機需要：
- 確保路由器已設定端口轉發
- 告知對手使用包含公網 IP 的連線方式，或
- 使用 VPN 等其他方式

#### 方式二：使用 VPN（最簡單）

1. 兩個玩家加入同一個虛擬局域網（例如 Hamachi、ZeroTier、Tailscale）
2. 主機生成房間號碼（會自動使用 VPN 虛擬 IP）
3. 客戶端輸入房間號碼即可連線
4. 無需設定端口轉發

#### 方式三：使用雲端伺服器

1. 在雲端伺服器（例如 AWS、Azure、DigitalOcean）上運行主機
2. 確保伺服器防火牆允許相應端口
3. 主機生成的房間號碼會包含伺服器的公網 IP
4. 客戶端輸入房間號碼即可連線

## 常見問題

### 房間號碼是什麼？

房間號碼是一個 10 位字符串，使用 Base32 編碼自動包含了主機的 IP 位址和端口資訊。這樣對手只需要輸入一個簡單的代碼就可以連接，而不需要手動輸入 IP 和端口。

### 連線失敗怎麼辦？

1. **檢查網路連線**：確保兩台電腦都能訪問網路
2. **檢查防火牆**：確保防火牆允許應用程式通訊
3. **驗證房間號碼**：確保輸入的房間號碼正確（10 位字符）
4. **檢查端口轉發**：如果跨網域，確保路由器端口轉發設定正確
5. **嘗試使用 VPN**：如果端口轉發設定複雜，可以使用 VPN 方案

### 房間號碼無效怎麼辦？

- 確保房間號碼是 10 位字符
- 確保沒有輸入易混淆的字符（0、O、I、L）
- 重新複製主機提供的房間號碼
- 檢查是否有額外的空格或換行符

### 遊戲中途斷線怎麼辦？

- 如果連線中斷，遊戲會顯示錯誤訊息
- 需要重新建立連線並開始新遊戲
- 當前棋局無法恢復

### 延遲很高怎麼辦？

- 網路延遲取決於網路品質
- 嘗試使用更穩定的網路連線
- 減少網路上的其他活動
- 考慮使用地理位置更近的連線方式

## 技術細節

### 房間號碼編碼

- 使用 Base32 編碼（32 個字符：1-9、A-Z，排除 0、O、I、L）
- 10 位字符可以編碼 48 位數據（32 位 IP + 16 位端口）
- 示例：192.168.1.100:8888 → 71P11Q99PS
- 自動避免易混淆字符，提高準確性

### 網路協議

- 使用 TCP/IP 協議確保可靠傳輸
- 採用 JSON 格式封裝遊戲訊息
- 支援以下訊息類型：
  - 棋步移動
  - 遊戲開始
  - 遊戲結束
  - 認輸
  - 新遊戲請求
  - 玩家資訊

### 安全性

- 目前版本不包含加密功能
- 建議在受信任的網路環境中使用
- 未來版本可能會增加加密支援

### 連線穩定性

- 使用心跳機制檢測連線狀態
- 自動處理連線中斷
- 支援斷線重連（需手動操作）

## 建議和提示

1. **測試連線**：首次使用時，建議在同一局域網內測試
2. **記錄設定**：記下常用的 IP 和端口設定
3. **保持連線**：對弈期間保持網路連線穩定
4. **防火牆設定**：如遇連線問題，檢查防火牆設定
5. **端口選擇**：如果預設端口被占用，可以更改為其他端口（建議使用 1024-65535 範圍內的端口）

## 更新日誌

### Version 1.0（初版）
- 基本網路對戰功能
- 支援主機/客戶端模式
- 即時棋步同步
- 連線狀態顯示
