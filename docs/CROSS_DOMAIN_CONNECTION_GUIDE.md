# 跨網域連線指南 (Cross-Domain Connection Guide)

## 📖 目錄

- [簡介](#簡介)
- [連線類型比較](#連線類型比較)
- [本地網絡連線](#本地網絡連線)
- [跨網域連線設置](#跨網域連線設置)
- [常見問題](#常見問題)
- [技術細節](#技術細節)

---

## 簡介

Qt_Chess 線上對戰功能支援兩種連線方式：

1. **本地網絡連線**：適用於同一 WiFi 或區域網路
2. **跨網域連線**：適用於不同網路環境（需要額外設定）

---

## 連線類型比較

| 特性 | 本地網絡連線 | 跨網域連線 |
|------|-------------|-----------|
| **適用場景** | 同一 WiFi/區域網路 | 不同網路/遠距離 |
| **設定難度** | ⭐ 簡單 | ⭐⭐⭐⭐ 需要技術知識 |
| **需要設定** | 無 | 端口轉發 + 公網 IP/域名 |
| **連線速度** | 非常快 | 取決於網路環境 |
| **推薦度** | ✅ 推薦一般使用者 | ⚠️ 推薦熟悉網路的使用者 |

---

## 本地網絡連線

### 使用條件
- 雙方連接到**同一個 WiFi** 或**同一個區域網路**
- 無需額外設定

### 操作步驟

1. **房主創建房間**
   - 點擊「🌐 線上」按鈕
   - 選擇「我要創建房間」
   - 點擊「開始」
   - 在彈出的對話框中，選擇「📶 本地網絡」頁面
   - 點擊「📋 複製連線碼」

2. **朋友加入房間**
   - 複製房主傳來的連線碼
   - 點擊「🌐 線上」按鈕
   - 選擇「我有連線碼」
   - 點擊「📋 從剪貼簿貼上」
   - 點擊「開始」

### 連線碼格式
```
192.168.1.100:1234
```
- `192.168.1.100` = 房主的本地 IP 地址
- `1234` = 房間號碼

---

## 跨網域連線設置

### ⚠️ 注意事項
跨網域連線需要一定的網路技術知識。如果您不熟悉以下概念，建議使用本地網絡連線：
- 路由器設定
- 端口轉發 (Port Forwarding)
- 公網 IP 地址
- 防火牆設定

### 使用條件
1. 房主需要有**公網 IP 地址**或**域名**
2. 房主需要在路由器設定**端口轉發**
3. 防火牆允許該端口的連線

---

## 詳細設置步驟

### 第一步：查詢您的公網 IP 地址

#### 方法一：使用網站查詢
1. 開啟瀏覽器
2. 搜尋「查詢IP」或「我的IP」
3. 訪問任何 IP 查詢網站（如 `whatismyip.com`）
4. 記下顯示的 IP 地址（例如：`203.0.113.1`）

#### 方法二：使用域名
如果您有自己的域名或使用動態 DNS 服務（如 No-IP、DynDNS），可以直接使用域名（例如：`myserver.example.com`）

---

### 第二步：設定路由器端口轉發

#### 基本概念
端口轉發將外部連線導向到您的電腦。

#### 設置步驟

1. **登入路由器管理介面**
   - 開啟瀏覽器
   - 輸入路由器 IP（通常是 `192.168.1.1` 或 `192.168.0.1`）
   - 輸入管理員帳號密碼

2. **找到端口轉發設定**
   - 不同品牌路由器位置不同，常見名稱：
     - Port Forwarding
     - Virtual Server
     - NAT 轉發
     - 虛擬伺服器

3. **新增轉發規則**
   - **服務名稱/描述**：`Qt_Chess`
   - **外部端口**：`房間端口`（例如 `11234`）
   - **內部端口**：`房間端口`（例如 `11234`）
   - **內部 IP**：您電腦的本地 IP（例如 `192.168.1.100`）
   - **協議**：選擇 `TCP` 或 `TCP/UDP`

4. **保存並套用設定**

#### 端口號碼計算
房間端口 = **10000 + 房間號碼**

例如：
- 房間號碼：`1234` → 端口：`11234`
- 房間號碼：`5678` → 端口：`15678`

---

### 第三步：設定防火牆

#### Windows 防火牆
1. 開啟「Windows 安全性」
2. 點擊「防火牆和網路保護」
3. 點擊「進階設定」
4. 選擇「輸入規則」
5. 點擊「新增規則」
6. 選擇「連接埠」，下一步
7. 選擇「TCP」，輸入「特定本機連接埠」，填入房間端口號
8. 允許連線，完成設定

#### macOS 防火牆
1. 開啟「系統偏好設定」
2. 點擊「安全性與隱私權」
3. 選擇「防火牆」標籤
4. 如果防火牆已啟用，點擊「防火牆選項」
5. 新增 Qt_Chess 應用程式，允許連入連線

#### Linux 防火牆 (UFW)
```bash
sudo ufw allow 房間端口/tcp
```

例如：
```bash
sudo ufw allow 11234/tcp
```

---

### 第四步：生成跨網域連線碼

1. **房主創建房間**
   - 點擊「🌐 線上」按鈕
   - 選擇「我要創建房間」
   - 點擊「開始」

2. **在房間資訊對話框中**
   - 切換到「🌐 跨網域連線」頁面
   - 輸入您的公網 IP 地址或域名
   - 點擊「🔗 生成跨網域連線碼」
   - 點擊「📋 複製跨網域連線碼」

3. **傳送連線碼給朋友**
   - 使用任何通訊軟體傳送連線碼
   - 朋友可以在任何網路環境下使用此連線碼加入

---

### 第五步：朋友加入房間

朋友的操作與本地網絡連線相同：

1. 複製房主傳來的跨網域連線碼
2. 點擊「🌐 線上」按鈕
3. 選擇「我有連線碼」
4. 點擊「📋 從剪貼簿貼上」
5. 點擊「開始」

**系統會自動識別連線碼類型（本地或跨網域），無需手動選擇！**

---

## 常見問題

### Q1: 跨網域連線失敗怎麼辦？

**檢查清單：**

1. ✅ **確認公網 IP 正確**
   - 重新查詢公網 IP
   - 如果使用域名，確認域名解析正確

2. ✅ **確認端口轉發設定**
   - 檢查路由器設定是否正確
   - 確認內部 IP 地址正確
   - 確認端口號碼正確

3. ✅ **確認防火牆設定**
   - 檢查 Windows/macOS/Linux 防火牆
   - 暫時關閉防火牆測試（測試完記得開啟）

4. ✅ **確認房主電腦正在運行**
   - 房主的 Qt_Chess 應用程式必須保持運行
   - 房主的電腦不能進入睡眠模式

5. ✅ **檢查 ISP 限制**
   - 某些網路服務商可能限制端口轉發
   - 嘗試使用不同的端口號碼

### Q2: 為什麼本地網絡連線可以，跨網域連線不行？

本地網絡連線不需要經過路由器的 NAT 轉換和防火牆，所以更簡單。跨網域連線需要：
- 公網 IP（不是所有用戶都有）
- 端口轉發設定
- 防火牆允許

### Q3: 我的 ISP 沒有提供公網 IP，怎麼辦？

**選項一：向 ISP 申請**
- 聯絡您的網路服務商
- 詢問是否可以取得公網 IP（可能需要額外費用）

**選項二：使用 VPN 或隧道服務**
- 使用 Hamachi、ZeroTier 等虛擬局域網服務
- 使用 ngrok、frp 等內網穿透工具（需要技術知識）

**選項三：使用本地網絡**
- 與朋友約定在同一地點連接同一 WiFi

### Q4: 連線碼可以重複使用嗎？

**本地網絡連線碼：**
- 每次創建房間會生成新的房號
- 本地 IP 地址可能會變動（如果使用 DHCP）

**跨網域連線碼：**
- 如果設定了固定的端口轉發和使用域名，可以重複使用
- 但房號每次都不同，仍需要生成新的連線碼

### Q5: 支援哪些連線碼格式？

系統自動識別以下格式：

```
✅ 192.168.1.100:1234
✅ 203.0.113.1:1234
✅ example.com:1234
✅ myserver.ddns.net:1234
✅ 192.168.1.100 1234（空格分隔）
```

### Q6: 如何測試端口轉發是否成功？

**方法一：使用線上工具**
1. 搜尋「端口檢測」或「port checker」
2. 輸入您的端口號碼
3. 確認房間已創建（應用程式正在監聽該端口）
4. 檢查結果

**方法二：請朋友嘗試連線**
- 這是最直接的測試方法

---

## 技術細節

### 網路架構

```
[朋友的電腦] 
    ↓
[網際網路]
    ↓
[您的公網 IP / 域名]
    ↓
[您的路由器] ← 端口轉發設定
    ↓
[您的電腦 (房主)] ← Qt_Chess 伺服器
```

### 端口範圍
- 房間號碼範圍：`1000` - `9999`
- 對應端口範圍：`11000` - `19999`
- 協議：`TCP`

### 連線流程

1. **房主創建房間**
   - 應用程式在 `0.0.0.0:端口` 監聽
   - `0.0.0.0` 表示接受來自任何網路介面的連線

2. **朋友加入房間**
   - 輸入連線碼（IP/域名:房號）
   - 應用程式解析連線碼
   - Qt 的 `QTcpSocket::connectToHost()` 進行 DNS 解析（如需要）
   - 建立 TCP 連線

3. **遊戲開始**
   - 所有棋步通過 TCP 連線同步
   - 使用 JSON 格式傳輸訊息

### 安全考量

#### ⚠️ 注意事項
- 開放端口可能帶來安全風險
- 只在需要時開啟端口轉發
- 遊戲結束後可以關閉端口轉發
- 定期更新路由器韌體

#### 建議
1. 只轉發必要的端口
2. 使用強密碼保護路由器
3. 定期檢查端口轉發規則
4. 考慮使用 VPN 作為更安全的替代方案

---

## 故障排除

### 連線超時

**可能原因：**
1. 端口轉發設定錯誤
2. 防火牆阻擋
3. 房主電腦不在線
4. ISP 限制

**解決方法：**
1. 仔細檢查端口轉發設定
2. 暫時關閉防火牆測試
3. 確認房主電腦和應用程式正在運行
4. 嘗試不同的端口號碼

### 連線建立後斷開

**可能原因：**
1. 網路不穩定
2. 路由器重啟
3. 防火牆規則改變
4. 應用程式錯誤

**解決方法：**
1. 檢查網路連線穩定性
2. 重新建立房間
3. 查看應用程式日誌（如有）

### 域名無法解析

**可能原因：**
1. 域名配置錯誤
2. DNS 伺服器問題
3. 域名過期

**解決方法：**
1. 檢查域名配置
2. 使用 `ping` 或 `nslookup` 測試域名解析
3. 暫時使用公網 IP 代替

---

## 結語

跨網域連線功能讓您可以和遠方的朋友一起下棋，但需要一些網路知識。如果覺得設定太複雜，建議：

1. 使用本地網絡連線（最簡單）
2. 約朋友到同一地點使用同一 WiFi
3. 尋求熟悉網路設定的朋友協助
4. 考慮使用 VPN 服務（如 Hamachi）簡化設定

**祝您下棋愉快！** ♟️🎮

---

## 相關文件

- [簡易使用指南](ONLINE_BEGINNER_GUIDE.md) - 基本線上對戰教學
- [線上模式功能](ONLINE_MODE_FEATURE.md) - 完整功能說明
- [視覺化操作指南](ONLINE_VISUAL_GUIDE.md) - 圖文教學
- [線上對戰文檔索引](ONLINE_README.md) - 所有相關文件
